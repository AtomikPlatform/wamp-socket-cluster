!function(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r(require("jsonschema"),require("lodash.get"),require("lodash.setwith")):"function"==typeof define&&define.amd?define("wampSocketCluster",["jsonschema","lodash.get","lodash.setwith"],r):"object"==typeof exports?exports.wampSocketCluster=r(require("jsonschema"),require("lodash.get"),require("lodash.setwith")):e.wampSocketCluster=r(e.jsonschema,e["lodash.get"],e["lodash.setwith"])}(this,function(e,r,t){return function(e){function r(s){if(t[s])return t[s].exports;var o=t[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,r),o.l=!0,o.exports}var t={};return r.m=e,r.c=t,r.i=function(e){return e},r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:s})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},r.p="",r(r.s=6)}([function(e,r,t){"use strict";function s(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}var o,n,i={id:"/WAMPResponse",type:"object",properties:{data:{},error:{},procedure:{type:"string"},signature:{type:"number"},success:{type:"boolean"},type:{type:"string"}},required:["type","procedure","signature","success","error"]},p={id:"/WAMPRequest",type:"object",properties:{data:{},signature:{type:"number"},procedure:{type:"string"},type:{type:"string"}},required:["type","procedure"]},c={id:"/MasterWAMPResponse",type:"object",properties:{data:{},error:{},procedure:{type:"string"},signature:{type:"number"},socketId:{type:"string"},success:{type:"boolean"},type:{type:"string"},workerId:{type:"number"}},required:["workerId","socketId","signature","type","procedure","success"]},u={id:"/MasterWAMPRequest",type:"object",properties:{data:{},procedure:{type:"string"},signature:{type:"number"},socketId:{type:"string"},type:{type:"string"},workerId:{type:"number"}},required:["workerId","socketId","type","procedure"]},a={id:"/InterProcessRPCResponseSchema",type:"object",properties:{data:{},error:{},procedure:{type:"string"},signature:{type:"number"},socketId:{type:"string"},success:{type:"boolean"},type:{type:"string"},workerId:{type:"number"}},required:["workerId","socketId","signature","type","procedure","success"]},d={id:"/InterProcessRPCRequestSchemaSchema",type:"object",properties:{data:{},procedure:{type:"string"},signature:{type:"number"},socketId:{type:"string"},type:{type:"string"},workerId:{type:"number"}},required:["workerId","socketId","signature","type","procedure"]},l={id:"/MasterConfigResponseSchema",type:"object",properties:{registeredEvents:{type:"array"},type:{type:"string"}},required:["registeredEvents","type"]},y={id:"/MasterConfigRequestSchema",type:"object",properties:{type:{type:"string"}},required:["type"]},f=(o={},s(o,i.id,p.id),s(o,c.id,p.id),s(o,a.id,d.id),s(o,l.id,y.id),o),m=(n={},s(n,p.id,i.id),s(n,u.id,i.id),s(n,d.id,a.id),s(n,y.id,l.id),n);e.exports={WAMPRequestSchema:p,WAMPResponseSchema:i,InterProcessRPCRequestSchema:d,InterProcessRPCResponseSchema:a,MasterWAMPResponseSchema:c,MasterWAMPRequestSchema:u,MasterConfigRequestSchema:y,MasterConfigResponseSchema:l,responsesIdsMap:f,requestsIdsMap:m}},function(e,r){e.exports=require("jsonschema")},function(e,r){e.exports=require("lodash.get")},function(e,r,t){"use strict";function s(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,r){for(var t=0;t<r.length;t++){var s=r[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(r,t,s){return t&&e(r.prototype,t),s&&e(r,s),r}}(),n=t(1).Validator,i=t(0),p=new n,c=function(){function e(){s(this,e),this.endpoints={rpc:{},event:{}}}return o(e,[{key:"upgradeToWAMP",value:function(e){var r=this;return console.log("[36m%s[0m","WAMPServer ----- upgradeToWAMP",this.endpoints),e.on("raw",function(t){console.log("[36m%s[0m","WAMPServer ----- RECEIVED RPC CALL",t.procedure);try{t=JSON.parse(t)}catch(e){return}p.validate(t,i.WAMPRequestSchema).valid&&t.type===i.WAMPRequestSchema.id?r.processWAMPRequest(t,e):console.log("[36m%s[0m","WAMPServer processWAMPRequest WAMPRequestSchema.errors",p.validate(t,i.WAMPRequestSchema).errors)}),Object.keys(this.endpoints.event).forEach(function(t){e.on(t,function(s){console.log("[36m%s[0m","WAMPServer ----- RECEIVED EVENT CALL",t,s),r.processWAMPRequest({type:i.WAMPRequestSchema.id,procedure:t,data:s},e)})}),e}},{key:"processWAMPRequest",value:function(e,r){return console.log("[36m%s[0m","WampServer ----- processWAMPRequest received call procedure",e.procedure),this.endpoints.rpc[e.procedure]&&"function"==typeof this.endpoints.rpc[e.procedure]?(console.log("[36m%s[0m","WampServer ----- processWAMPRequest RPC"),this.endpoints.rpc[e.procedure](e.data,this.reply.bind(this,r,e))):this.endpoints.event[e.procedure]&&"function"==typeof this.endpoints.event[e.procedure]?(console.log("[36m%s[0m","WampServer ----- processWAMPRequest Event"),this.endpoints.event[e.procedure](e.data)):(console.log("[36m%s[0m","WampServer ----- processWAMPRequest not registered. reply now"),this.reply(r,e,"procedure "+e.procedure+" not registered on WAMPServer",null))}},{key:"reply",value:function(e,r,t,s){e.send(JSON.stringify({success:!t,data:s,error:t,type:i.WAMPResponseSchema.id,procedure:r.procedure,signature:r.signature}))}},{key:"registerRPCEndpoints",value:function(e){console.log("[36m%s[0m","ENDPOINTS: registerRPCEndpoints",e),this.endpoints.rpc=Object.assign(this.endpoints.rpc,e)}},{key:"registerEventEndpoints",value:function(e){console.log("[36m%s[0m","ENDPOINTS: registerEVENTEndpoints",e),this.endpoints.event=Object.assign(this.endpoints.event,e)}},{key:"reassignRPCEndpoints",value:function(e){console.log("[36m%s[0m","ENDPOINTS: reassignPCEndpoints",e),this.endpoints.rpc=e}},{key:"reassignEventEndpoints",value:function(e){console.log("[36m%s[0m","ENDPOINTS: reassignEventEndpoints",e),this.endpoints.event=e}}]),e}();e.exports=c},function(e,r){e.exports=require("lodash.setwith")},,function(e,r,t){"use strict";function s(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function o(e,r){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!r||"object"!=typeof r&&"function"!=typeof r?e:r}function n(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)}var i=function(){function e(e,r){for(var t=0;t<r.length;t++){var s=r[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(r,t,s){return t&&e(r.prototype,t),s&&e(r,s),r}}(),p=t(1).Validator,c=(t(4),t(2),t(3)),u=t(0),a=new p,d=function(e){function r(e){s(this,r);var t=o(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return t.socketCluster=e,e.on("workerStart",function(e){console.log("[33m%s[0m","MasterWAMPServer: on workerStart --- sending endpoints to new worker",t.endpoints),t.reply(null,{registeredEvents:Object.keys(t.endpoints.event),type:u.MasterConfigRequestSchema.id,workerId:e.id})}),e.on("workerMessage",function(e,r){console.log("[33m%s[0m","MasterWAMPServer: on workerMessage ",r),a.validate(r,u.MasterWAMPRequestSchema).valid?(console.log("[33m%s[0m","MasterWAMPServer: ON workerMessage ----- passed validation invoking RPC procedure:",t.endpoints.rpc),t.processWAMPRequest(r,null)):console.log("[36m%s[0m","MasterWAMPServer ON workerMessage ----- WAMPRequestSchema.errors",a.validate(r,u.MasterWAMPRequestSchema).errors)}),t}return n(r,e),i(r,[{key:"reply",value:function(e,r,t,s){return console.log("[36m%s[0m","MasterWAMPServer ----- reply type",r.workerId,r.type===u.MasterWAMPResponseSchema.id?u.MasterWAMPResponseSchema.id:u.InterProcessRPCResponseSchema.id),this.socketCluster.sendToWorker(r.workerId,Object.assign(r,{data:s,error:t,success:!t,procedure:r.procedure,workerId:r.workerId,socketId:r.socketId,signature:r.signature,type:u.requestsIdsMap[r.type]}))}}]),r}(c);e.exports=d}])});